```php
# RabbitMQ - рж╕ржорзНржкрзВрж░рзНржг ржмрж╛ржВрж▓рж╛ ржЧрж╛ржЗржб (PHP рж╕ржВрж╕рзНржХрж░ржг)

---

## ЁЯУЦ RabbitMQ ржХрж┐?

**рж╕ржВржЬрзНржЮрж╛**: RabbitMQ рж╣рж▓рзЛ ржПржХржЯрж┐ ржУржкрзЗржи рж╕рзЛрж░рзНрж╕ **Message Broker** рж╕ржлржЯржУржпрж╝рзНржпрж╛рж░ ржпрж╛ ржмрж┐ржнрж┐ржирзНржи ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржоржзрзНржпрзЗ ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛рждрзЗ ржПржмржВ ржЧрзНрж░рж╣ржг ржХрж░рждрзЗ рж╕рж╛рж╣рж╛ржпрзНржп ржХрж░рзЗред

**рж╕рж╣ржЬ ржнрж╛рж╖рж╛ржпрж╝**: 
- ржзрж░рзБржи ржЖржкржирж╛рж░ ржПржХржЯрж┐ рж░рзЗрж╕рзНрждрзЛрж░рж╛ржБ ржЖржЫрзЗ
- **Customer (ржкрзНрж░рзЛржбрж┐ржЙрж╕рж╛рж░)** = ржЕрж░рзНржбрж╛рж░ ржжрзЗржпрж╝
- **Waiter (RabbitMQ)** = ржЕрж░рзНржбрж╛рж░ ржирж┐ржпрж╝рзЗ рж░рж╛ржирзНржирж╛ржШрж░рзЗ ржкрзМржБржЫрж╛ржпрж╝
- **Chef (ржХржиржЬрж┐ржЙржорж╛рж░)** = ржЕрж░рзНржбрж╛рж░ рж░рж╛ржирзНржирж╛ ржХрж░рзЗ

RabbitMQ рж╣рж▓рзЛ рж╕рзЗржЗ **Waiter** ржпрзЗ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗ ржЕрж░рзНржбрж╛рж░ рж╕ржарж┐ржХржнрж╛ржмрзЗ ржкрзМржБржЫрзЗржЫрзЗред

---

## ЁЯЫая╕П PHP рждрзЗ RabbitMQ ржЗржирж╕рзНржЯрж▓рзЗрж╢ржи

```bash
# Composer ржжрж┐ржпрж╝рзЗ PHP AMQP Library ржЗржирж╕рзНржЯрж▓ ржХрж░рзБржи
composer require php-amqplib/php-amqplib

# Docker ржжрж┐ржпрж╝рзЗ RabbitMQ рж╕рж╛рж░рзНржнрж╛рж░ ржЪрж╛рж▓рж╛ржи
docker run -d --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:management

# ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗ Management UI: http://localhost:15672 (guest/guest)
```

---

## ЁЯУЛ PHP рждрзЗ ржорзМрж▓рж┐ржХ ржЙржжрж╛рж╣рж░ржг

### рзз. Producer (ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ)

```php
<?php
// producer.php
require_once __DIR__ . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

// RabbitMQ рж╕ржВржпрзЛржЧ
$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection->channel();

// Exchange рждрзИрж░рж┐
$channel->exchange_declare('order_exchange', 'direct', false, true, false);

// ржЕрж░рзНржбрж╛рж░ ржбрж╛ржЯрж╛
$order = [
    'order_id' => 'ORD-2025-001',
    'customer_name' => 'ржХрж░рж┐ржо ржорж┐ржпрж╝рж╛',
    'product' => 'рж▓рзНржпрж╛ржкржЯржк',
    'price' => 45000,
    'quantity' => 1
];

$message = new AMQPMessage(json_encode($order, JSON_UNESCAPED_UNICODE), [
    'delivery_mode' => AMQPMessage::DELIVERY_MODE_PERSISTENT,
    'content_type' => 'application/json'
]);

// ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржи
$channel->basic_publish($message, 'order_exchange', 'order.new');

echo "тЬЕ ржЕрж░рзНржбрж╛рж░ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ: {$order['order_id']}\n";

$channel->close();
$connection->close();
```

### рзи. Consumer (ржорзЗрж╕рзЗржЬ ржЧрзНрж░рж╣ржг)

```php
<?php
// consumer.php
require_once __DIR__ . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;

// RabbitMQ рж╕ржВржпрзЛржЧ
$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection->channel();

// Exchange ржУ Queue рждрзИрж░рж┐
$channel->exchange_declare('order_exchange', 'direct', false, true, false);
$channel->queue_declare('new_orders', false, true, false, false);
$channel->queue_bind('new_orders', 'order_exchange', 'order.new');

echo "тП│ ржЕрж░рзНржбрж╛рж░рзЗрж░ ржЬржирзНржп ржЕржкрзЗржХрзНрж╖рж╛ ржХрж░ржЫрж┐...\n";

// ржХрж▓ржмрж╛ржХ ржлрж╛ржВрж╢ржи
$callback = function ($msg) {
    $order = json_decode($msg->body, true);
    
    echo str_repeat('=', 50) . PHP_EOL;
    echo "ЁЯУж ржирждрзБржи ржЕрж░рзНржбрж╛рж░ ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗ!" . PHP_EOL;
    echo "ржЕрж░рзНржбрж╛рж░ ржЖржЗржбрж┐: {$order['order_id']}" . PHP_EOL;
    echo "ржХрж╛рж╕рзНржЯржорж╛рж░: {$order['customer_name']}" . PHP_EOL;
    echo "ржкржгрзНржп: {$order['product']}" . PHP_EOL;
    echo "ржорзВрж▓рзНржп: рз│{$order['price']}" . PHP_EOL;
    echo str_repeat('=', 50) . PHP_EOL;
    
    // ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╕рж┐ржорзБрж▓рзЗржЯ
    sleep(2);
    echo "тЬЕ ржЕрж░рзНржбрж╛рж░ рж╕ржлрж▓ржнрж╛ржмрзЗ ржкрзНрж░рж╕рзЗрж╕ рж╣ржпрж╝рзЗржЫрзЗ!" . PHP_EOL . PHP_EOL;
    
    // ACK ржкрж╛ржарж╛ржи
    $msg->ack();
};

// Consumer ржЪрж╛рж▓рзБ
$channel->basic_consume('new_orders', '', false, false, false, false, $callback);

while ($channel->is_consuming()) {
    $channel->wait();
}

$channel->close();
$connection->close();
```

---

## ЁЯПЧя╕П PHP рждрзЗ Advanced ржЙржжрж╛рж╣рж░ржг

### Dead Letter Exchange рж╕рж╣ Queue

```php
<?php
// setup_dlx.php
require_once __DIR__ . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Exchange\AMQPExchangeType;

$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection->channel();

// Dead Letter Exchange рждрзИрж░рж┐
$channel->exchange_declare('dlx', AMQPExchangeType::FANOUT, false, true, false);
$channel->queue_declare('failed_orders', false, true, false, false);
$channel->queue_bind('failed_orders', 'dlx');

// Main Queue with DLX
$channel->queue_declare('main_orders', false, true, false, false, false, [
    'x-dead-letter-exchange' => ['S', 'dlx'],
    'x-message-ttl' => ['I', 300000], // 5 ржорж┐ржирж┐ржЯ
    'x-max-length' => ['I', 1000]
]);

echo "тЬЕ DLX рж╕рзЗржЯржЖржк рж╕ржорзНржкржирзНржи\n";
$channel->close();
$connection->close();
```

### Priority Queue

```php
<?php
// priority_producer.php
require_once __DIR__ . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStreamConnection('localhost', 5672, 'guest', 'guest');
$channel = $connection->channel();

// Priority Queue рждрзИрж░рж┐
$channel->queue_declare('priority_orders', false, true, false, false, false, [
    'x-max-priority' => ['I', 10]
]);

// ржмрж┐ржнрж┐ржирзНржи priority ржПрж░ ржорзЗрж╕рзЗржЬ
$messages = [
    ['body' => 'VIP Customer ржЕрж░рзНржбрж╛рж░', 'priority' => 10],
    ['body' => 'рж╕рж╛ржзрж╛рж░ржг ржЕрж░рзНржбрж╛рж░', 'priority' => 5],
    ['body' => 'ржиржи-ржЖрж░рзНржЬрзЗржирзНржЯ ржЕрж░рзНржбрж╛рж░', 'priority' => 1]
];

foreach ($messages as $data) {
    $msg = new AMQPMessage($data['body'], [
        'delivery_mode' => AMQPMessage::DELIVERY_MODE_PERSISTENT,
        'priority' => $data['priority']
    ]);
    $channel->basic_publish($msg, '', 'priority_orders');
    echo "тЬЕ Priority {$data['priority']} ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗ\n";
}

$channel->close();
$connection->close();
```

---

## ЁЯЪА ржХрж┐ржнрж╛ржмрзЗ ржЪрж╛рж▓рж╛ржмрзЗржи

```bash
# Terminal 1: Consumer ржЪрж╛рж▓рзБ ржХрж░рзБржи
php consumer.php

# Terminal 2: Producer ржЪрж╛рж▓рзБ ржХрж░рзБржи
php producer.php

# Priority Queue ржЯрзЗрж╕рзНржЯ
php priority_producer.php
```

---

## ЁЯУК PHP vs Python рж╕ржВржХрзНрж╖рж┐ржкрзНржд рждрзБрж▓ржирж╛

| ржмрж┐рж╖ржпрж╝ | Python (pika) | PHP (php-amqplib) |
|------|---------------|-------------------|
| ржЗржирж╕рзНржЯрж▓рзЗрж╢ржи | `pip install pika` | `composer require php-amqplib/php-amqplib` |
| рж╕ржВржпрзЛржЧ | `pika.BlockingConnection()` | `AMQPStreamConnection()` |
| Exchange рждрзИрж░рж┐ | `channel.exchange_declare()` | `$channel->exchange_declare()` |
| ржорзЗрж╕рзЗржЬ ржкрж╛ржарж╛ржирзЛ | `channel.basic_publish()` | `$channel->basic_publish()` |
| ржорзЗрж╕рзЗржЬ ржЧрзНрж░рж╣ржг | `channel.basic_consume()` | `$channel->basic_consume()` |
| ACK | `ch.basic_ack()` | `$msg->ack()` |

---

## ЁЯОп PHP рждрзЗ рж╕рзЗрж░рж╛ ржЕржирзБрж╢рзАрж▓ржи

1. **рж╕ржмрж╕ржоржпрж╝ Exchange ржУ Queue declare ржХрж░рзБржи** ржкрзНрж░ржержорзЗ
2. **Persistent ржорзЗрж╕рзЗржЬ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи** (`delivery_mode = 2`)
3. **ACK/NACK рж╕ржарж┐ржХржнрж╛ржмрзЗ рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рзБржи**
4. **Connection pooling** ржмржбрж╝ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗ ржмрж┐ржмрзЗржЪржирж╛ ржХрж░рзБржи
5. **Error handling** ржпрзЛржЧ ржХрж░рзБржи try-catch ржмрзНрж▓ржХ ржжрж┐ржпрж╝рзЗ
6. **DLX ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи** ржмрзНржпрж░рзНрже ржорзЗрж╕рзЗржЬрзЗрж░ ржЬржирзНржп
7. **Priority queue** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржорзЗрж╕рзЗржЬрзЗрж░ ржЬржирзНржп

---

## ЁЯУЪ ржЕрждрж┐рж░рж┐ржХрзНржд рж░рж┐рж╕рзЛрж░рзНрж╕

- [php-amqplib GitHub](https://github.com/php-amqplib/php-amqplib)
- [RabbitMQ PHP Tutorials](https://www.rabbitmq.com/tutorials/tutorial-one-php.html)
- [Composer Package](https://packagist.org/packages/php-amqplib/php-amqplib)

**ржПржЗ ржЧрж╛ржЗржб ржЕржирзБрж╕рж░ржг ржХрж░рзЗ ржЖржкржирж┐ PHP рждрзЗ RabbitMQ рж╕рж╣ржЬрзЗржЗ ржЗржирзНржЯрж┐ржЧрзНрж░рзЗржЯ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи! ЁЯОЙ**
```
