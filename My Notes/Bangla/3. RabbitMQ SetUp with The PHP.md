ржирж┐рж╢рзНржЪржпрж╝! ржирж┐ржЪрзЗ **RabbitMQ тАУ рж╕рзЗржЯржЖржк ржУ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи** рж╕ржорзНржкрж░рзНржХрж┐ржд ржПржХржЗ ржзрж░ржирзЗрж░ ржкрзВрж░рзНржгрж╛ржЩрзНржЧ ржирзЛржЯ ржжрзЗржУржпрж╝рж╛ рж╣рж▓рзЛ, ржХрж┐ржирзНрждрзБ ржПржмрж╛рж░ **PHP (Laravel/PHP-CLI)** ржПрж░ ржЬржирзНржпред ржПржЯрж┐ ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░рзЗ PHP ржмрзНржпржмрж╣рж╛рж░ржХрж╛рж░рзАржжрзЗрж░ ржЬржирзНржп ржЦрзБржм ржХрж╛ржЬрзЗ рж▓рж╛ржЧржмрзЗред

---

# ЁЯРШ RabbitMQ тАУ PHP-ржП рж╕рзЗржЯржЖржк ржУ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи  
## ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░рзЗрж░ ржЬржирзНржп (PHP/Laravel)

---

## 1. **RabbitMQ рж╕рж╛рж░рзНржнрж╛рж░ рж╕рзЗржЯржЖржк (Docker)**

> PHP ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржЬржирзНржп RabbitMQ рж╕рж╛рж░рзНржнрж╛рж░ ржЖрж▓рж╛ржжрж╛ тАФ рждрж╛ржЗ ржкрзНрж░ржержорзЗ RabbitMQ ржЪрж╛рж▓рзБ ржХрж░рзБржи:

```bash
docker run -d \
  --name rabbitmq \
  -p 5672:5672 \
  -p 15672:15672 \
  -e RABBITMQ_DEFAULT_USER=admin \
  -e RABBITMQ_DEFAULT_PASS=secret \
  rabbitmq:3-management
```

- **5672**: AMQP ржкрзЛрж░рзНржЯ (PHP ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржХрж╛ржирзЗржХрзНржЯ ржХрж░ржмрзЗ)
- **15672**: Web UI тЖТ http://localhost:15672

---

## 2. **PHP-ржП RabbitMQ ржХрзНрж▓рж╛ржпрж╝рзЗржирзНржЯ ржЗржирж╕рзНржЯрж▓**

### тЬЕ **ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ ржкрзНржпрж╛ржХрзЗржЬ: `php-amqplib`**

```bash
composer require php-amqplib/php-amqplib
```

> ЁЯУМ ржПржЯрж┐ PHP-ржПрж░ ржЬржирзНржп рж╕ржмржЪрзЗржпрж╝рзЗ ржЬржиржкрзНрж░рж┐ржпрж╝ ржПржмржВ рж╕рзНржЯрзЗржмрж▓ AMQP рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ред

---

## 3. **ржХрж╛ржирзЗржХрж╢ржи рж╕рзЗржЯржЖржк (PHP)**

```php
<?php
require_once __DIR__ . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;

$connection = new AMQPStreamConnection(
    'localhost',    // host
    5672,           // port
    'admin',        // username
    'secret',       // password
    '/'             // vhost
);

$channel = $connection->channel();
```

> тЬЕ **vhost** ржкрж░рж┐ржмрж░рзНрждржи ржХрж░рзБржи ржпржжрж┐ ржЖржкржирж┐ ржЖрж▓рж╛ржжрж╛ vhost (ржпрзЗржоржи: `/ecommerce`) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржиред

---

## 4. **Exchange, Queue & Binding рждрзИрж░рж┐ (PHP)**

```php
// Exchange рждрзИрж░рж┐ (Direct)
$channel->exchange_declare(
    'order.exchange',   // name
    'direct',           // type
    false,              // passive
    true,               // durable тЖТ рж╕рж╛рж░рзНржнрж╛рж░ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ ржерж╛ржХржмрзЗ
    false               // auto_delete
);

// DLX Exchange рждрзИрж░рж┐
$channel->exchange_declare('dlx.exchange', 'direct', false, true, false);

// Queue рждрзИрж░рж┐ + DLX рж╕рзЗржЯ
$channel->queue_declare(
    'order.queue',
    false,
    true,  // durable
    false, // exclusive
    false, // auto_delete
    false,
    new \PhpAmqpLib\Wire\AMQPTable([
        'x-dead-letter-exchange'    => 'dlx.exchange',
        'x-dead-letter-routing-key' => 'order.failed'
    ])
);

// Binding
$channel->queue_bind('order.queue', 'order.exchange', 'order.created');

// DLQ рждрзИрж░рж┐
$channel->queue_declare('dlq.order', false, true, false, false);
$channel->queue_bind('dlq.order', 'dlx.exchange', 'order.failed');
```

> тЪая╕П **`durable=true`** рж╕рзЗржЯ ржХрж░рзБржи тАФ ржирж╛рж╣рж▓рзЗ рж╕рж╛рж░рзНржнрж╛рж░ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ Queue/Exchange ржорзБржЫрзЗ ржпрж╛ржмрзЗ!

---

## 5. **Producer (PHP)**

```php
$data = json_encode(['order_id' => '123', 'user_id' => 456]);

$msg = new AMQPMessage(
    $data,
    [
        'delivery_mode' => AMQPMessage::DELIVERY_MODE_PERSISTENT, // ржбрж┐рж╕рзНржХрзЗ рж╕рзНржЯрзЛрж░
        'content_type'  => 'application/json'
    ]
);

$channel->basic_publish(
    $msg,
    'order.exchange',
    'order.created' // routing key
);

echo " [x] Sent order.created\n";
```

> тЬЕ **`DELIVERY_MODE_PERSISTENT`** тЖТ ржорзЗрж╕рзЗржЬ ржбрж┐рж╕рзНржХрзЗ рж╕рзЗржн рж╣ржмрзЗ (рж╕рж╛рж░рзНржнрж╛рж░ ржХрзНрж░рзНржпрж╛рж╢ рж╣рж▓рзЗржУ рж▓рж╕ рж╣ржмрзЗ ржирж╛)ред

---

## 6. **Consumer (PHP тАУ Worker)**

```php
echo " [*] Waiting for messages. To exit press CTRL+C\n";

$callback = function ($msg) {
    echo " [x] Received ", $msg->body, "\n";
    
    try {
        $data = json_decode($msg->body, true);
        // ржЖржкржирж╛рж░ ржмрж┐ржЬржирзЗрж╕ рж▓ржЬрж┐ржХ ржПржЦрж╛ржирзЗ (ржпрзЗржоржи: ржкрзЗржорзЗржирзНржЯ ржкрзНрж░рж╕рзЗрж╕)
        processOrder($data);
        
        // Manual ACK тЖТ рж╢рзБржзрзБ рж╕ржлрж▓ рж╣рж▓рзЗржЗ ACK
        $msg->ack();
        echo " [тЬУ] Order processed & ACK sent\n";
        
    } catch (Exception $e) {
        echo " [!] Error: " . $e->getMessage() . "\n";
        // requeue=false тЖТ DLQ-рждрзЗ ржпрж╛ржмрзЗ
        $msg->nack(false, false); // (multiple=false, requeue=false)
    }
};

// QoS: ржПржХрж╕рж╛ржерзЗ 1ржЯрж┐ ржорзЗрж╕рзЗржЬ ржкрзНрж░рж╕рзЗрж╕ ржХрж░ржмрзЗ
$channel->basic_qos(null, 1, null);

// Consumer рж╕рзЗржЯ
$channel->basic_consume(
    'order.queue',
    '',
    false,  // no_local
    false,  // no_ack тЖТ FALSE! (Manual ACK)
    false,  // exclusive
    false,  // nowait
    $callback
);

// Keep running
while ($channel->is_consuming()) {
    $channel->wait();
}

$channel->close();
$connection->close();

function processOrder($data) {
    // ржЖржкржирж╛рж░ рж▓ржЬрж┐ржХ
    if (empty($data['order_id'])) {
        throw new Exception("Invalid order");
    }
    sleep(2); // simulate work
}
```

> тЪая╕П **`no_ack = false`** + **`$msg->ack()`** тЖТ ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓ ACK  
> тЪая╕П **`$msg->nack(false, false)`** тЖТ `requeue=false` рж░рж╛ржЦрзБржи, ржирж╛рж╣рж▓рзЗ ржЗржиржлрж┐ржирж┐ржЯ рж▓рзБржк!

---

## 7. **Laravel-ржП RabbitMQ (ржЕржкрж╢ржирж╛рж▓)**

Laravel-ржП RabbitMQ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рждрзЗ ржЪрж╛ржЗрж▓рзЗ ржирж┐ржЪрзЗрж░ ржкрзНржпрж╛ржХрзЗржЬржЧрзБрж▓рзЛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи:

### тЬЕ **Option 1: `vladimir-yuldashev/laravel-queue-rabbitmq`**

```bash
composer require vladimir-yuldashev/laravel-queue-rabbitmq
```

**`.env`**:
```env
QUEUE_CONNECTION=rabbitmq
RABBITMQ_HOST=localhost
RABBITMQ_PORT=5672
RABBITMQ_LOGIN=admin
RABBITMQ_PASSWORD=secret
RABBITMQ_VHOST=/
```

**`config/queue.php`**:
```php
'rabbitmq' => [
    'driver' => 'rabbitmq',
    'queue' => env('RABBITMQ_QUEUE', 'default'),
    'connection' => PhpAmqpLib\Connection\AMQPStreamConnection::class,
    'hosts' => [
        [
            'host' => env('RABBITMQ_HOST', '127.0.0.1'),
            'port' => env('RABBITMQ_PORT', 5672),
            'user' => env('RABBITMQ_LOGIN', 'guest'),
            'password' => env('RABBITMQ_PASSWORD', 'guest'),
            'vhost' => env('RABBITMQ_VHOST', '/'),
        ],
    ],
    'options' => [
        'queue' => [
            'declare' => true, // Queue auto-declare
            'durable' => true,
            'arguments' => [
                'x-dead-letter-exchange' => ['S', 'dlx.exchange'],
                'x-dead-letter-routing-key' => ['S', 'failed']
            ]
        ],
    ],
],
```

рждрж╛рж░ржкрж░ Laravel Job ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи:

```php
php artisan make:job ProcessOrder

// In ProcessOrder.php
public function handle()
{
    // ржЖржкржирж╛рж░ рж▓ржЬрж┐ржХ
}
```

Dispatch:
```php
ProcessOrder::dispatch($orderData)->onQueue('order.queue');
```

> тЬЕ Laravel-ржП рж╕рзНржмржпрж╝ржВржХрзНрж░рж┐ржпрж╝ржнрж╛ржмрзЗ **ACK**, **Retry**, **DLQ** рж╣рзНржпрж╛ржирзНржбрж▓ рж╣ржпрж╝ (ржХржиржлрж┐ржЧ ржарж┐ржХ ржерж╛ржХрж▓рзЗ)ред

---

## 8. **ржкрзНрж░рзЛржбрж╛ржХрж╢ржи ржмрзЗрж╕рзНржЯ ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕ (PHP)**

| ржмрж┐рж╖ржпрж╝ | ржХрж░ржгрзАржпрж╝ |
|------|--------|
| **Durable** | Exchange, Queue, Message тАФ рж╕ржм `durable/persistent` рж╕рзЗржЯ ржХрж░рзБржи |
| **Manual ACK** | `no_ack=false` + `$msg->ack()` |
| **QoS** | `$channel->basic_qos(null, 1, null)` тЖТ ржУржпрж╝рж╛рж░рзНржХрж╛рж░ ржУржнрж╛рж░рж▓рзЛржб рж░рзЛржз |
| **DLX** | рж╕ржм Queue-ржП `x-dead-letter-exchange` рж╕рзЗржЯ ржХрж░рзБржи |
| **Error Handling** | `try-catch` + `nack(requeue=false)` |
| **Supervisor** | Consumer рж╕рзНржХрзНрж░рж┐ржкрзНржЯ Supervisor ржжрж┐ржпрж╝рзЗ рж░рж╛ржи ржХрж░рзБржи (crash рж╣рж▓рзЗ ржЕржЯрзЛ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯ) |

### ЁЯУД **Supervisor ржХржиржлрж┐ржЧ (Linux)**

`/etc/supervisor/conf.d/order-worker.conf`:

```ini
[program:order-worker]
command=/usr/bin/php /var/www/worker.php
autostart=true
autorestart=true
user=www-data
redirect_stderr=true
stdout_logfile=/var/log/order-worker.log
```

рждрж╛рж░ржкрж░:
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start order-worker:*
```

---

## 9. **рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк тАУ PHP ржЪрзЗржХрж▓рж┐рж╕рзНржЯ**

тЬЕ RabbitMQ рж╕рж╛рж░рзНржнрж╛рж░ (Docker/Cluster)  
тЬЕ `php-amqplib` ржЗржирж╕рзНржЯрж▓  
тЬЕ Connection + Channel рж╕рзЗржЯржЖржк  
тЬЕ Exchange/Queue/DLX ржкрзНрж░рзЛржЧрзНрж░рж╛ржорзЗржЯрж┐ржХ рждрзИрж░рж┐  
тЬЕ Producer: `delivery_mode = PERSISTENT`  
тЬЕ Consumer: Manual ACK + QoS + `nack(requeue=false)`  
тЬЕ Laravel ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ тЖТ `laravel-queue-rabbitmq`  
тЬЕ Supervisor ржжрж┐ржпрж╝рзЗ Worker ржорзНржпрж╛ржирзЗржЬ  
тЬЕ ржоржирж┐ржЯрж░рж┐ржВ: RabbitMQ UI + рж▓ржЧ ржлрж╛ржЗрж▓  

---

> тЬЕ **ржоржирзЗ рж░рж╛ржЦрзБржи**:  
> **PHP-ржП RabbitMQ = ржЕрзНржпрж╛рж╕рж┐ржЩрзНржХрзНрж░рзЛржирж╛рж╕ ржЯрж╛рж╕рзНржХ + рж╕рзНржХрзЗрж▓рзЗржмрж▓ ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ + ржирж┐рж░рж╛ржкржж ржорзЗрж╕рзЗржЬрж┐ржВ**

---

ржПржЗ ржирзЛржЯржЯрж┐ ржЕржирзБрж╕рж░ржг ржХрж░рзЗ ржЖржкржирж┐ **PHP-ржП ржкрзНрж░рзЛржбрж╛ржХрж╢ржи-ржЧрзНрж░рзЗржб RabbitMQ ржЗржирзНржЯрж┐ржЧрзНрж░рзЗрж╢ржи** ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи ржПржмржВ ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░рзЗ рж░ржмрж╛рж╕рзНржЯ, рж╕рзНржХрзЗрж▓рзЗржмрж▓ ржУ ржлрж▓рзНржЯ-ржЯрж▓рж╛рж░рзЗржирзНржЯ рж╕рж┐рж╕рзНржЯрзЗржо рждрзИрж░рж┐ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред ЁЯЪА
