ржирж┐рж╢рзНржЪржпрж╝! ржирж┐ржЪрзЗ RabbitMQ-ржПрж░ **рж╕рзЗржЯржЖржк ржУ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи** рж╕ржорзНржкрж░рзНржХрж┐ржд ржПржХржЯрж┐ ржкрзВрж░рзНржгрж╛ржЩрзНржЧ, ржкрзНрж░ржпрзЛржЬрзНржп ржПржмржВ ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ ржбрж┐ржЬрж╛ржЗржирзЗрж░ ржЬржирзНржп ржЙржкржпрзЛржЧрзА **ржмрж╛ржВрж▓рж╛ ржирзЛржЯ** ржжрзЗржУржпрж╝рж╛ рж╣рж▓рзЛред

---

# ЁЯЫая╕П RabbitMQ тАУ рж╕рзЗржЯржЖржк ржУ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи (Setup & Configuration)  
## ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░рзЗрж░ ржЬржирзНржп

---

## 1. **RabbitMQ ржЗржирж╕рзНржЯрж▓рзЗрж╢ржи**

### тЬЕ **Docker (рж╕ржмржЪрзЗржпрж╝рзЗ рж╕рж╣ржЬ ржЙржкрж╛ржпрж╝)**

```bash
# RabbitMQ + Management UI (port 15672)
docker run -d \
  --name rabbitmq \
  -p 5672:5672 \
  -p 15672:15672 \
  -e RABBITMQ_DEFAULT_USER=admin \
  -e RABBITMQ_DEFAULT_PASS=secret \
  rabbitmq:3-management
```

- **5672**: AMQP ржкрзНрж░рзЛржЯрзЛржХрж▓рзЗрж░ ржЬржирзНржп (Producer/Consumer ржХрж╛ржирзЗржХрж╢ржи)
- **15672**: Web-based Management UI (http://localhost:15672)

> ЁЯТб **ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ UI рж▓ржЧржЗржи**:  
> ржЗржЙржЬрж╛рж░: `admin`  
> ржкрж╛рж╕ржУржпрж╝рж╛рж░рзНржб: `secret`

---

### тЬЕ **Ubuntu/Debian (APT ржжрж┐ржпрж╝рзЗ)**

```bash
sudo apt update
sudo apt install rabbitmq-server -y
sudo systemctl enable rabbitmq-server
sudo systemctl start rabbitmq-server

# Management Plugin ржЪрж╛рж▓рзБ ржХрж░рзБржи
sudo rabbitmq-plugins enable rabbitmq_management

# ржбрж┐ржлрж▓рзНржЯ ржЧрзЗрж╕рзНржЯ ржЗржЙржЬрж╛рж░ рж╢рзБржзрзБ localhost ржерзЗржХрзЗ ржХрж╛ржЬ ржХрж░рзЗред
# рж░рж┐ржорзЛржЯ ржЕрзНржпрж╛ржХрзНрж╕рзЗрж╕рзЗрж░ ржЬржирзНржп ржирждрзБржи ржЗржЙржЬрж╛рж░ рждрзИрж░рж┐ ржХрж░рзБржи:
sudo rabbitmqctl add_user myuser mypass
sudo rabbitmqctl set_user_tags myuser administrator
sudo rabbitmqctl set_permissions -p / myuser ".*" ".*" ".*"
```

---

## 2. **ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржлрж╛ржЗрж▓**

RabbitMQ-ржПрж░ ржкрзНрж░ржзрж╛ржи ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи ржлрж╛ржЗрж▓:  
`/etc/rabbitmq/rabbitmq.conf` (Linux)  
ржмрж╛ Docker-ржП volume mount ржХрж░рзЗ ржХрж╛рж╕рзНржЯржорж╛ржЗржЬ ржХрж░рж╛ ржпрж╛ржпрж╝ред

### ЁЯУД ржЙржжрж╛рж╣рж░ржг: `rabbitmq.conf`

```ini
# ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржХржиржлрж┐ржЧ
listeners.tcp.default = 5672
management.tcp.port = 15672

# ржбрж┐ржлрж▓рзНржЯ vhost
default_vhost = /

# ржбрж┐рж╕рзНржХ ржлрзНрж░рж┐ рж▓рж┐ржорж┐ржЯ (рж╕рзНржкрзЗрж╕ ржХржо рж╣рж▓рзЗ ржорзЗрж╕рзЗржЬ ржЧрзНрж░рж╣ржг ржмржирзНржз ржХрж░ржмрзЗ)
disk_free_limit.absolute = 2GB

# ржорзЗрж╕рзЗржЬ TTL (ржпржжрж┐ ржХрж┐ржЙрждрзЗ 1 ржШржирзНржЯрж╛ ржерж╛ржХрзЗ, рждржмрзЗ ржЕржЯрзЛ ржбрж┐рж▓рж┐ржЯ)
queue.default_message_ttl = 3600000

# DLX ржбрж┐ржлрж▓рзНржЯ рж╕рзЗржЯрж┐ржВ (ржЕржкрж╢ржирж╛рж▓)
# queue.declare arguments ржП x-dead-letter-exchange ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
```

> ЁЯУМ **vhost (Virtual Host)**: ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ ржкрзНрж░ржЬрзЗржХрзНржЯ ржЕржирзБржпрж╛ржпрж╝рзА ржЖрж▓рж╛ржжрж╛ vhost ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи (ржпрзЗржоржи: `/ecommerce`, `/payment`) тАФ ржПржЯрж┐ ржЖржЗрж╕рзЛрж▓рзЗрж╢ржи ржжрзЗржпрж╝ред

---

## 3. **Exchange, Queue & Binding рждрзИрж░рж┐ (ржкрзНрж░рзЛржЧрзНрж░рж╛ржорзЗржЯрж┐ржХржнрж╛ржмрзЗ)**

### тЬЕ **Python (Pika рж▓рж╛ржЗржмрзНрж░рзЗрж░рж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ)**

```python
import pika

# ржХрж╛ржирзЗржХрж╢ржи
connection = pika.BlockingConnection(
    pika.ConnectionParameters(
        host='localhost',
        port=5672,
        virtual_host='/',
        credentials=pika.PlainCredentials('admin', 'secret')
    )
)
channel = connection.channel()

# Exchange рждрзИрж░рж┐ (Direct)
channel.exchange_declare(
    exchange='order.exchange',
    exchange_type='direct',
    durable=True  # рж╕рж╛рж░рзНржнрж╛рж░ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ ржерж╛ржХржмрзЗ
)

# Queue рждрзИрж░рж┐ + DLX рж╕рзЗржЯ
channel.queue_declare(
    queue='order.queue',
    durable=True,
    arguments={
        "x-dead-letter-exchange": "dlx.exchange",
        "x-dead-letter-routing-key": "order.failed"
    }
)

# Binding
channel.queue_bind(
    queue='order.queue',
    exchange='order.exchange',
    routing_key='order.created'
)

# DLX Exchange & DLQ рждрзИрж░рж┐
channel.exchange_declare(exchange='dlx.exchange', exchange_type='direct', durable=True)
channel.queue_declare(queue='dlq.order', durable=True)
channel.queue_bind(queue='dlq.order', exchange='dlx.exchange', routing_key='order.failed')
```

> тЬЕ **`durable=True`** рж╕рзЗржЯ ржХрж░рзБржи тАФ ржирж╛рж╣рж▓рзЗ рж╕рж╛рж░рзНржнрж╛рж░ рж░рж┐рж╕рзНржЯрж╛рж░рзНржЯрзЗ рж╕ржм ржбрзЗржЯрж╛ ржорзБржЫрзЗ ржпрж╛ржмрзЗ!

---

## 4. **Producer & Consumer ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи**

### ЁЯФ╕ **Producer (Python)**

```python
channel.basic_publish(
    exchange='order.exchange',
    routing_key='order.created',
    body=json.dumps({"order_id": "123"}),
    properties=pika.BasicProperties(
        delivery_mode=2,  # ржорзЗрж╕рзЗржЬ ржбрж┐рж╕рзНржХрзЗ рж╕рзНржЯрзЛрж░ рж╣ржмрзЗ (persistent)
        content_type='application/json'
    )
)
```

### ЁЯФ╕ **Consumer (Python)**

```python
def callback(ch, method, properties, body):
    try:
        print("Processing:", body)
        # ржЖржкржирж╛рж░ рж▓ржЬрж┐ржХ ржПржЦрж╛ржирзЗ
        ch.basic_ack(delivery_tag=method.delivery_tag)  # Manual ACK
    except Exception as e:
        print("Error:", e)
        ch.basic_nack(delivery_tag=method.delivery_tag, requeue=False)  # DLQ-рждрзЗ ржпрж╛ржмрзЗ

channel.basic_qos(prefetch_count=1)  # ржПржХрж╕рж╛ржерзЗ 1ржЯрж┐ ржорзЗрж╕рзЗржЬ
channel.basic_consume(queue='order.queue', on_message_callback=callback)
channel.start_consuming()
```

> тЪая╕П **`requeue=False`** рж╕рзЗржЯ ржХрж░рзБржи тАФ ржирж╛рж╣рж▓рзЗ ржлрзЗржЗрж▓ржб ржорзЗрж╕рзЗржЬ ржЖржмрж╛рж░ ржХрж┐ржЙрждрзЗ ржврзБржХржмрзЗ ржПржмржВ ржЗржиржлрж┐ржирж┐ржЯ рж▓рзБржк рж╣ржмрзЗ!

---

## 5. **ржХрзНрж▓рж╛рж╕рзНржЯрж╛рж░рж┐ржВ ржУ рж╣рж╛ржЗ ржЕрзНржпрж╛ржнрзЗржЗрж▓рзЗржмрж┐рж▓рж┐ржЯрж┐ (HA)**

### тЬЕ **Mirrored Queues (HA Policy)**

RabbitMQ-ржП **Queue Mirroring** рж╕рзЗржЯ ржХрж░рзЗ ржорж╛рж▓рзНржЯрж┐ржкрж▓ ржирзЛржбрзЗ ржХрж┐ржЙ рж░рж┐ржкрзНрж▓рж┐ржХрзЗржЯ ржХрж░рж╛ ржпрж╛ржпрж╝ред

```bash
# CLI ржжрж┐ржпрж╝рзЗ HA Policy рж╕рзЗржЯ
rabbitmqctl set_policy ha-all ".*" '{"ha-mode":"all"}'
```

ржЕржержмрж╛ Management UI тЖТ Admin тЖТ Policies тЖТ Add Policy:

- **Name**: `ha-policy`
- **Pattern**: `.*` (рж╕ржм ржХрж┐ржЙ)
- **Definition**:  
  ```json
  {
    "ha-mode": "all",
    "ha-sync-mode": "automatic"
  }
  ```

> ЁЯУМ **ржХрзНрж▓рж╛рж╕рзНржЯрж╛рж░ рж╕рзЗржЯржЖржк**: ржХржоржкржХрзНрж╖рзЗ 3 ржирзЛржб (odd number) тАФ ржирзЗржЯржУржпрж╝рж╛рж░рзНржХ ржкрж╛рж░рзНржЯрж┐рж╢ржи рж╣рзНржпрж╛ржирзНржбрж▓рж┐ржВржпрж╝рзЗрж░ ржЬржирзНржпред

---

## 6. **рж╕рж┐ржХрж┐ржЙрж░рж┐ржЯрж┐ ржмрзЗрж╕рзНржЯ ржкрзНрж░рзНржпрж╛ржХржЯрж┐рж╕**

| ржмрж┐рж╖ржпрж╝ | ржХрж░ржгрзАржпрж╝ |
|------|--------|
| **ржЗржЙржЬрж╛рж░ ржорзНржпрж╛ржирзЗржЬржорзЗржирзНржЯ** | `guest` ржЗржЙржЬрж╛рж░ ржбрж┐рж╕рзЗржмрж▓ ржХрж░рзБржи; ржкрзНрж░рждрж┐ рж╕рж╛рж░рзНржнрж┐рж╕рзЗрж░ ржЬржирзНржп ржЖрж▓рж╛ржжрж╛ ржЗржЙржЬрж╛рж░ |
| **vhost ржЖржЗрж╕рзЛрж▓рзЗрж╢ржи** | ржкрзНрж░рждрж┐ ржкрзНрж░ржЬрзЗржХрзНржЯ/ржЯрж┐ржорзЗрж░ ржЬржирзНржп ржЖрж▓рж╛ржжрж╛ vhost |
| **TLS/SSL** | ржкрзНрж░рзЛржбрж╛ржХрж╢ржирзЗ AMQP over TLS (5671) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи |
| **ржлрж╛ржпрж╝рж╛рж░ржУржпрж╝рж╛рж▓** | 5672, 15672 ржкрзЛрж░рзНржЯ рж╢рзБржзрзБ ржЯрзНрж░рж╛рж╕рзНржЯрзЗржб ржирзЗржЯржУржпрж╝рж╛рж░рзНржХрзЗ ржУржкрзЗржи рж░рж╛ржЦрзБржи |

---

## 7. **ржоржирж┐ржЯрж░рж┐ржВ ржУ рж▓ржЧрж┐ржВ**

- **Management UI**: Queue length, consumer count, message rates
- **Prometheus + Grafana**: `rabbitmq_exporter` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
- **рж▓ржЧ ржлрж╛ржЗрж▓**: `/var/log/rabbitmq/` (Linux)
- **ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ**: Queue length > 1000 рж╣рж▓рзЗ Slack/Email ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯ

---

## 8. **ржкрзНрж░рзЛржбрж╛ржХрж╢ржи ржЪрзЗржХрж▓рж┐рж╕рзНржЯ**

тЬЕ RabbitMQ ржХрзНрж▓рж╛рж╕рзНржЯрж╛рж░ (3+ ржирзЛржб)  
тЬЕ Mirrored Queues (HA Policy)  
тЬЕ TLS рж╕ржХрзНрж░рж┐ржпрж╝  
тЬЕ ржкрзНрж░рждрж┐ рж╕рж╛рж░рзНржнрж┐рж╕рзЗрж░ ржЬржирзНржп ржЖрж▓рж╛ржжрж╛ vhost ржУ ржЗржЙржЬрж╛рж░  
тЬЕ рж╕ржм Queue & Exchange `durable=True`  
тЬЕ рж╕ржм ржорзЗрж╕рзЗржЬ `persistent` (delivery_mode=2)  
тЬЕ DLX + DLQ ржХржиржлрж┐ржЧрж╛рж░рзНржб  
тЬЕ Consumer-ржП Manual ACK + QoS (prefetch_count=1)  
тЬЕ ржоржирж┐ржЯрж░рж┐ржВ ржУ ржЕрзНржпрж╛рж▓рж╛рж░рзНржЯрж┐ржВ рж╕рзЗржЯ  

---

## ЁЯУМ рж╕рж╛рж░рж╕ржВржХрзНрж╖рзЗржк

| ржзрж╛ржк | ржХрж╛ржЬ |
|-----|-----|
| **1. ржЗржирж╕рзНржЯрж▓** | Docker ржмрж╛ APT ржжрж┐ржпрж╝рзЗ RabbitMQ + Management Plugin |
| **2. ржХржиржлрж┐ржЧ** | `rabbitmq.conf` ржжрж┐ржпрж╝рзЗ ржкрзЛрж░рзНржЯ, vhost, disk limit рж╕рзЗржЯ |
| **3. ржХржорзНржкрзЛржирзЗржирзНржЯ рждрзИрж░рж┐** | Exchange, Queue (DLX рж╕рж╣), Binding тАФ ржкрзНрж░рзЛржЧрзНрж░рж╛ржорзЗржЯрж┐ржХржнрж╛ржмрзЗ |
| **4. Producer/Consumer** | Persistent message + Manual ACK + QoS |
| **5. HA & Security** | Cluster, Mirroring, TLS, vhost isolation |
| **6. Monitor** | UI + Prometheus + Alerting |

---

> тЬЕ **ржоржирзЗ рж░рж╛ржЦрзБржи**:  
> **"рж╕ржарж┐ржХ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи = ржорзЗрж╕рзЗржЬ рж▓рж╕ ржиржпрж╝ + рж╕рж┐рж╕рзНржЯрзЗржо рж░рзЗржЬрж┐рж▓рж┐ржпрж╝рзЗржирзНржЯ + рж╕рзНржХрзЗрж▓рзЗржмрж▓"**

---

ржПржЗ ржирзЛржЯржЯрж┐ ржЕржирзБрж╕рж░ржг ржХрж░рзЗ ржЖржкржирж┐ **ржкрзНрж░рзЛржбрж╛ржХрж╢ржи-рж░рзЗржбрж┐ RabbitMQ рж╕рзЗржЯржЖржк** ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи ржПржмржВ ржорж╛ржЗржХрзНрж░рзЛрж╕рж╛рж░рзНржнрж┐рж╕ ржЖрж░рзНржХрж┐ржЯрзЗржХржЪрж╛рж░рзЗ ржирж┐рж░рж╛ржкржж, рж╕рзНржХрзЗрж▓рзЗржмрж▓ ржУ рж░ржмрж╛рж╕рзНржЯ ржорзЗрж╕рзЗржЬрж┐ржВ рж╕рж┐рж╕рзНржЯрзЗржо ржЧржбрж╝рзЗ рждрзБрж▓рждрзЗ ржкрж╛рж░ржмрзЗржиред ЁЯЪА
